<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>

  <!-- Header -->
  <header class="top-header">
    <div class="logo-section">
      <img src="{{ url_for('static', filename='images/logo.jpeg') }}" alt="School Logo" class="school-logo">
      <span class="institution-name">Silver Stream</span>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav>
      <ul>
        <li><a href="{{ url_for('admin_dashboard') }}"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
        <li><a href="{{ url_for('admin_staff') }}"><i class="bi bi-people"></i> <span>Staff</span></a></li>
        <li><a href="{{ url_for('admin_classes') }}"><i class="bi bi-building"></i> <span>Classes</span></a></li>
        <li><a href="{{ url_for('admin_exams') }}"><i class="bi bi-journal-text"></i> <span>Exams</span></a></li>
        <li><a href="{{ url_for('admin_results') }}"><i class="bi bi-bar-chart-line"></i> <span>Results</span></a></li>
        <li><a href="{{ url_for('admin_stats') }}"><i class="bi bi-graph-up"></i> <span>Stats</span></a></li>
      </ul>
    </nav>
  </aside>

<!-- Main Content -->
<main class="main-content">

  <section class="page-header">
    <h2>Fees Management</h2>
  </section>

  <!-- Class Filter -->
  <section class="class-buttons">
    <h4>Select Class</h4>
    <div class="button-group">
      {% for class_item in classes %}
        <a href="{{ url_for('admin_accounts', class_id=class_item.id) }}"
           class="class-btn {% if selected_class_id == class_item.id %}active{% endif %}">
          {{ class_item.name }} {{ class_item.stream }}
        </a>
      {% endfor %}
    </div>
  </section>

  <!-- Student Fee Table -->
  {% if student_fees %}
  <section class="table-section">
    <table class="fees-table">
      <thead>
        <tr>
          <th>Student</th>
          <th>Term</th>
          <th>Year</th>
          <th>Amount Due</th>
          <th>Amount Paid</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for record in student_fees %}
        <tr>
          <td>{{ record.student_name }}</td>
          <td>{{ record.term or '—' }}</td>
          <td>{{ record.year or '—' }}</td>
          <td>KES {{ "{:,.2f}".format(record.amount_due or 0) }}</td>
          <td>KES {{ "{:,.2f}".format(record.amount_paid or 0) }}</td>
          <td>
            {% if record.status == 'Paid' %}
              <span class="status-badge paid">Paid</span>
            {% elif record.status == 'Partial' %}
              <span class="status-badge partial">Partial</span>
            {% elif record.status == 'Unpaid' %}
              <span class="status-badge unpaid">Unpaid</span>
            {% else %}
              <span class="status-badge unpaid">N/A</span>
            {% endif %}
          </td>
          <td>
            {% if record.fee_id %}
              <button type="button" class="btn-edit" onclick="toggleForm('{{ record.fee_id }}')" title="Edit Fees">
                <i class="bi bi-pencil-square"></i> Edit Fees
              </button>
            {% endif %}
            <a href="{{ url_for('admin_fee_payments', student_id=record.student_id) }}" class="btn-view" title="View Payments">
              <i class="bi bi-receipt"></i> View Payments
            </a>
          </td>
        </tr>

        {% if record.fee_id %}
        <!-- Inline Edit Form Row -->
        <tr id="form-row-{{ record.fee_id }}" class="edit-row" style="display: none;">
          <td colspan="7">
            <form method="POST" class="fee-edit-form">
              <input type="hidden" name="fee_id" value="{{ record.fee_id }}">
              <div class="form-group">
                <label>Amount Due:</label>
                <input type="number" name="amount_due" value="{{ record.amount_due or '' }}" step="0.01" min="0" required>
              </div>
              <div class="form-group">
                <label>Amount Paid:</label>
                <input type="number" name="amount_paid" value="{{ record.amount_paid or '' }}" step="0.01" min="0" required>
              </div>
              <div class="form-group">
                <label>Status:</label>
                <select name="status" required>
                  <option value="Unpaid" {% if record.status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                  <option value="Partial" {% if record.status == 'Partial' %}selected{% endif %}>Partial</option>
                  <option value="Paid" {% if record.status == 'Paid' %}selected{% endif %}>Paid</option>
                </select>
              </div>
              <button type="submit" class="btn-save">Save</button>
              <button type="button" class="btn-cancel" onclick="toggleForm('{{ record.fee_id }}')">Cancel</button>
            </form>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% elif selected_class_id %}
    <p>No fee records found for this class.</p>
  {% endif %}
</main>

<!-- Toggle Form Script -->
<script>
  function toggleForm(feeId) {
    const formRow = document.getElementById('form-row-' + feeId);
    if (!formRow) return;

    const isVisible = formRow.style.display === 'table-row';

    // Hide all others
    document.querySelectorAll('.edit-row').forEach(row => {
      row.style.display = 'none';
    });

    // Show the clicked one
    formRow.style.display = isVisible ? 'none' : 'table-row';
  }
</script>
